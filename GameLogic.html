<html lang="en">
<head>
        <title>Whack-A-Mole Game</title>
	    <meta name="viewport" content="width=device-width, initial-scale=1" />
	    <meta charset="utf-8" />
	    <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <!-- style sheets for whack-a-mole targets -->
        <style>
        .circleCentral{
            border-radius:100%;
            width: 30px;
            height: 30px;
            background: green;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .circle10px{
            border-radius:100%;
            width: 10px;
            height: 10px;
            background: red;
            position: absolute;
            transform: translate(-50%, -50%);
        }

        .circle30px{
            border-radius:100%;
            width: 30px;
            height: 30px;
            background: red;
            position: absolute;
            transform: translate(-50%, -50%);
        }

        .circle50px{
            border-radius:100%;
            width: 50px;
            height: 50px;
            background: red;
            position: absolute;
            transform: translate(-50%, -50%);
        }        
        </style>
</head>

<!-- Page HTML -->
<body onload="StartUpSettings()">
    <!-- TODO: add score, round count..etc -->
    <div id = "centralCircle" class="circleCentral" onclick="StartRound()"></div>

    <h1>
        <p id="title">Whack-A-Mole</p>
        <p id="text"></p>
    </h1>
    <p id="alert"></p>
</body>

<script type="text/javascript">
    
    var score = 0;
    var round = 0;
    var minInterval = 1500; // 1.5 second is the minimum interval
    var maxInterval = 4000; // 4 seconds is the maximum interval (will be changed as the game progresses)

    // arrays to store the data
    var showTime = [61];    // data starts at index 1
    var reactTime = [61];
    var successFlag = [61]; // 1 = success, 0 = fail
    var targetSize = [61];  // 1 = 10px, 2 = 30px, 3 = 50px
    var scoreArray = [61];  // score at the end of each round
    var distance = [61];    // distance between the target and the central circle

    // add reaction time
    var reactionTime = 0;

    // position variables
    var x;
    var y;

    // get the screen size
    var screenWidth = window.innerWidth;
    var screenHeight = window.innerHeight;

    var startTime;
    var endTime;
    var circlePointer;

    function StartRound()
    {

        // hide the central circle
        document.getElementById("centralCircle").style.visibility = "hidden";

        // remove the central circle
        // var centralCircle = document.getElementById("centralCircle");
        // centralCircle.parentNode.removeChild(centralCircle);
        
        round++;

        // if round is 30, decrease the interval
        if(round == 30)
        {
            // tell the user that the interval is decreasing
            document.getElementById("alert").innerHTML = "Circle will appear faster now!";
            minInterval = 1000;
            maxInterval = 3000;
        }

        // if round is 50, decrease the interval
        if(round == 50)
        {
            document.getElementById("alert").innerHTML = "F*ck!! Circle will appear even faster now!";
            minInterval = 500;
            maxInterval = 1500;
        }

        // create target circle
        circlePointer = document.createElement("div");
        circlePointer.setAttribute("id", "targetCircle");

        ShowTarget();
        
    }

    function ShowTarget()
    {
        
        // get the current time
        startTime = new Date().getTime();
        
        // generate random position for the circle within the screen but not too close to the edge
        x = Math.floor(Math.random() * (screenWidth - 100)) + 50;
        // leave 50px at the top for the text
        y = Math.floor(Math.random() * (screenHeight - 150)) + 100;

        // calculate the distance between the target and the central circle
        distance[round] = Math.sqrt(Math.pow((x - screenWidth/2), 2) + Math.pow((y - screenHeight/2), 2));

        // swith case to determine the size of the circle
        var randomSize = Math.floor(Math.random() * 3);
        switch(randomSize)
        {
            case 0:
                circlePointer.setAttribute("class", "circle10px");
                circlePointer.setAttribute("onclick", "HitTarget(30)");
                targetSize[round] = 1;
                break;
            case 1:
                circlePointer.setAttribute("class", "circle30px");
                circlePointer.setAttribute("onclick", "HitTarget(20)");
                targetSize[round] = 2;
                break;
            case 2:
                circlePointer.setAttribute("class", "circle50px");
                circlePointer.setAttribute("onclick", "HitTarget(10)");
                targetSize[round] = 3;
                break;
        }

        // show the circle
        circlePointer.style.top = y + "px";
        circlePointer.style.left = x + "px";
        document.body.appendChild(circlePointer);

        // if target is not hit, remove the circle


        // remove the circle after random time within minInterval and maxInterval
        var randomTime = Math.floor(Math.random() * (maxInterval - minInterval)) + minInterval;
        showTime[round] = randomTime;

        setTimeout(function(){
            if(document.getElementById("targetCircle") != null){
                // remove the circle
                document.getElementById("targetCircle").remove();
                MissTarget();
            }
            
        },  randomTime);

    }

    function EndGame(){

        // show the final score
        document.getElementById("text").innerHTML = "Game has ended! <br> Final Score: " + score + " <br> Good Job!";
        // tell the user to refresh the page to play again
        document.getElementById("text").innerHTML += "<br> Refresh the page to play again";
        // clear the alert
        document.getElementById("alert").innerHTML = "";

        // call the function to generate the csv file
        GenerateCSV();
    }

    function HitTarget(scoreValue)
    {
            successFlag[round] = 1;
            // clear the circle from the screen
            document.getElementById("targetCircle").remove();

            // get the current time
            endTime = new Date().getTime();

            // calculate the reaction time
            reactionTime = endTime - startTime;
            reactTime[round] = reactionTime;
            
            // add score
            score += scoreValue;
            scoreArray[round] = score;

            // tell the user that they hit the target
            document.getElementById("text").innerHTML = "Hit! <br> Score: " + score + " <br> Round: " + round;
            // update the reaction time
            document.getElementById("text").innerHTML += "<br> Reaction Time: " + reactionTime + " ms";
            // if the round is not 60, start the next round
            if(round == 60)
            {
                EndGame();
            }
            // show the central circle
            document.getElementById("centralCircle").style.visibility = "visible";
            // show the data in the console
            console.log("Round: " + round + " | Show Time: " + showTime[round] + " | Reaction Time: " + reactTime[round] + " | Success: " + successFlag[round] + " | Target Size: " + targetSize[round] + " | Score: " + scoreArray[round] + " | Target Distance: " + distance[round]);
            }

    function MissTarget()
    {
        successFlag[round] = 0;
        reactTime[round] = 0;
        scoreArray[round] = score;

        // update the score
        document.getElementById("text").innerHTML = "Missed! <br> Score: " + score + " <br> Round: " + round;
        // update the reaction time
        document.getElementById("text").innerHTML += "<br> Reaction Time: " + reactionTime + " ms";
        // if the round is not 60, start the next round
        if(round == 60)
        {
            EndGame();
        }

        // show the central circle
        document.getElementById("centralCircle").style.visibility = "visible";
        // show the data in the console
        console.log("Round: " + round + " | Show Time: " + showTime[round] + " | Reaction Time: " + reactTime[round] + " | Success: " + successFlag[round] + " | Target Size: " + targetSize[round] + " | Score: " + scoreArray[round] + " | Target Distance: " + distance[round]);
    }

    function GenerateCSV()
    {
        // create the csv file
        var csv = "Round,Show Time(ms),Reaction Time(ms),Success,Target Size,Score,Distance from Center\n";
        for(var i = 1; i <= 60; i++)
        {
            csv += i + "," + showTime[i] + "," + reactTime[i] + "," + successFlag[i] + "," + targetSize[i] + "," + scoreArray[i] + "," + distance[i] + "\n";
        }

        // create a link to download the csv file
        var link = document.createElement("a");
        link.setAttribute("href", "data:text/csv;charset=utf-8," + encodeURIComponent(csv));
        link.setAttribute("download", "whackamole.csv");
        link.click();
    }

</script>

</html>